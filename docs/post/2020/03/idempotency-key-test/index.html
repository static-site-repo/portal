<!DOCTYPE html>
<html lang="zh-tw" itemscope itemtype="http://schema.org/WebPage">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Idempotency Key：原理與實測 - Potioneer&#39;s Essays</title>
  

<meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta name="MobileOptimized" content="width"/>
<meta name="HandheldFriendly" content="true"/>


<meta name="applicable-device" content="pc,mobile">

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<meta name="mobile-web-app-capable" content="yes">

<meta name="author" content="William Yeh" />
  <meta name="description" content="最近幾年，在微服務打滾的人，不時會遇到神祕的 &amp;ldquo;idempotency key&amp;rdquo; 字眼。本文爬梳 idempotency key 的技術背景，探討運作流程，並分析資料庫的實作選項。
Idempotency 冪等性 在 API 服務中，常常需要留意 idempotency（冪等性）。
名詞：idempotency，形容詞：idempotent。
&amp;ldquo;Idempotency&amp;rdquo; 這字眼源自數學。維基百科是這麼解釋 &amp;ldquo;idempotent function&amp;rdquo; 的：
" />




<meta name="google-site-verification" content="yB1imGx4TfWC72pIx33DNfg9RWg2gzU9CizwtvY5Hqo" />


<meta name="generator" content="Hugo 0.78.0" />


<link rel="canonical" href="//william-yeh.net/post/2020/03/idempotency-key-test/" />





<link rel="icon" href="/favicon.ico" />











<link rel="stylesheet" href="/sass/jane.min.fa3d941d1d0e0ddc985804227feabffea55c89883eb0af34e0532a7ae9135151.css" integrity="sha256-&#43;j2UHR0ODdyYWAQif&#43;q//qVciYg&#43;sK804FMqeukTUVE=" media="screen" crossorigin="anonymous">





<meta property="og:title" content="Idempotency Key：原理與實測" />
<meta property="og:description" content="最近幾年，在微服務打滾的人，不時會遇到神祕的 &ldquo;idempotency key&rdquo; 字眼。本文爬梳 idempotency key 的技術背景，探討運作流程，並分析資料庫的實作選項。
Idempotency 冪等性
在 API 服務中，常常需要留意 idempotency（冪等性）。
名詞：idempotency，形容詞：idempotent。
&ldquo;Idempotency&rdquo; 這字眼源自數學。維基百科是這麼解釋 &ldquo;idempotent function&rdquo; 的：" />
<meta property="og:type" content="article" />
<meta property="og:url" content="//william-yeh.net/post/2020/03/idempotency-key-test/" />
<meta property="article:published_time" content="2020-03-10T23:00:00+08:00" />
<meta property="article:modified_time" content="2020-03-10T23:00:00+08:00" />
<meta itemprop="name" content="Idempotency Key：原理與實測">
<meta itemprop="description" content="最近幾年，在微服務打滾的人，不時會遇到神祕的 &ldquo;idempotency key&rdquo; 字眼。本文爬梳 idempotency key 的技術背景，探討運作流程，並分析資料庫的實作選項。
Idempotency 冪等性
在 API 服務中，常常需要留意 idempotency（冪等性）。
名詞：idempotency，形容詞：idempotent。
&ldquo;Idempotency&rdquo; 這字眼源自數學。維基百科是這麼解釋 &ldquo;idempotent function&rdquo; 的：">
<meta itemprop="datePublished" content="2020-03-10T23:00:00+08:00" />
<meta itemprop="dateModified" content="2020-03-10T23:00:00+08:00" />
<meta itemprop="wordCount" content="4678">



<meta itemprop="keywords" content="microservice,ddd,database," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Idempotency Key：原理與實測"/>
<meta name="twitter:description" content="最近幾年，在微服務打滾的人，不時會遇到神祕的 &ldquo;idempotency key&rdquo; 字眼。本文爬梳 idempotency key 的技術背景，探討運作流程，並分析資料庫的實作選項。
Idempotency 冪等性
在 API 服務中，常常需要留意 idempotency（冪等性）。
名詞：idempotency，形容詞：idempotent。
&ldquo;Idempotency&rdquo; 這字眼源自數學。維基百科是這麼解釋 &ldquo;idempotent function&rdquo; 的："/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-751859-3', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>



</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Potioneer&#39;s Essays</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="//william-yeh.net/">♜</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="//william-yeh.net/post/">Archives</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="//william-yeh.net/tags/">Tags</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="//william-yeh.net/categories/">Categories</a>
          
        
      </li>
    

    
  </ul>
</nav>


  
    






  <link rel="stylesheet" href="/lib/photoswipe/photoswipe.min.css" />
  <link rel="stylesheet" href="/lib/photoswipe/default-skin/default-skin.min.css" />




<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>

  

  

  

  <header id="header" class="header container">
    <div class="logo-wrapper">
  <a href="/" class="logo">
    
      Potioneer&#39;s Essays
    
  </a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="//william-yeh.net/">♜</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="//william-yeh.net/post/">Archives</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="//william-yeh.net/tags/">Tags</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="//william-yeh.net/categories/">Categories</a>
          

        

      </li>
    

    
    

    
  </ul>
</nav>

  </header>

  <div id="mobile-panel">
    <main id="main" class="main bg-llight">
      <div class="content-wrapper">
        <div id="content" class="content container">
          <article class="post bg-white">
    
    <header class="post-header">
      <h1 class="post-title">Idempotency Key：原理與實測</h1>
      
      <div class="post-meta">
        <time datetime="2020-03-10" class="post-time">
          2020-03-10
        </time>
        <div class="post-category">
            <a href="//william-yeh.net/categories/tech/"> tech </a>
            
          </div>
        <span class="more-meta"> 約 4678 字 </span>
          <span class="more-meta"> 預計閱讀 10 分鐘 </span>

        
        
          <span id="busuanzi_container_page_pv">
            | 阅读 <span id="busuanzi_value_page_pv"></span>
          </span>
        

        
        
      </div>
    </header>

    
    
<div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目錄</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#idempotency-冪等性">Idempotency 冪等性</a></li>
    <li><a href="#non-idempotent-操作有必要存在嗎">Non-idempotent 操作有必要存在嗎？</a></li>
    <li><a href="#http-的-idempotency-規範">HTTP 的 idempotency 規範</a></li>
    <li><a href="#web-api-的-idempotency-問題">Web API 的 idempotency 問題</a></li>
    <li><a href="#向-tcp-取經">向 TCP 取經</a></li>
    <li><a href="#識別碼由誰來產生">識別碼，由誰來產生？</a></li>
    <li><a href="#idempotency-key-的生成">Idempotency key 的生成</a></li>
    <li><a href="#idempotency-key-的儲存">Idempotency key 的儲存</a></li>
    <li><a href="#致謝">致謝</a></li>
  </ul>
</nav>
  </div>
</div>

    
    <div class="post-content">
      <p>最近幾年，在微服務打滾的人，不時會遇到神祕的 &ldquo;idempotency key&rdquo; 字眼。本文爬梳 idempotency key 的技術背景，探討運作流程，並分析資料庫的實作選項。</p>
<h2 id="idempotency-冪等性">Idempotency 冪等性</h2>
<p>在 API 服務中，常常需要留意 idempotency（冪等性）。</p>
<p>名詞：idempotency，形容詞：idempotent。</p>
<p>&ldquo;Idempotency&rdquo; 這字眼源自數學。維基百科是這麼解釋 &ldquo;<a href="https://en.wikipedia.org/wiki/Idempotence#Idempotent_functions">idempotent function</a>&rdquo; 的：</p>
<blockquote>
<p>idempotent elements are the functions <em>f</em>: <em>E</em> → <em>E</em> [&hellip;] such that for all <em>x</em> in <em>E</em>, <em>f</em>(<em>f</em>(<em>x</em>)) = <em>f</em>(<em>x</em>)</p>
</blockquote>
<p>如果套用到電腦界 <sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup>，idempotency 性質可以詮釋成：</p>
<ul>
<li><em>f</em>：可以是 function 或是 API endpoint。</li>
<li><em>x</em>：可以是 argument 或是 API header &amp; payload。</li>
<li>如果 <em>f</em> 是 idempotent，就代表：對 <em>f</em>(<em>x</em>) 執行 1 次產生的效果，與執行 <em>N</em> 次產生的效果，完全一樣。</li>
</ul>
<p>譬如說，如果有一個管理商品庫存的服務：</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">Item</span> <span class="kd">struct</span> <span class="p">{</span><span class="cm">/*...*/</span><span class="p">}</span>

<span class="kd">type</span> <span class="nx">ItemInventory</span> <span class="kd">interface</span> <span class="p">{</span>
	<span class="kd">func</span> <span class="nf">GetQuantity</span><span class="p">(</span><span class="nx">item</span> <span class="nx">Item</span><span class="p">)</span> <span class="kt">int</span>       <span class="c1">// 查詢庫存量   
</span><span class="c1"></span>	<span class="kd">func</span> <span class="nf">SetQuantity</span><span class="p">(</span><span class="nx">item</span> <span class="nx">Item</span><span class="p">,</span> <span class="nx">num</span> <span class="kt">int</span><span class="p">)</span>  <span class="c1">// 設定庫存量
</span><span class="c1"></span>	<span class="kd">func</span> <span class="nf">DecreaseQuantity</span><span class="p">(</span><span class="nx">item</span> <span class="nx">Item</span><span class="p">)</span>      <span class="c1">// 庫存量減一
</span><span class="c1"></span><span class="p">}</span>
</code></pre></div><p>那麼，像以下這些動作，呼叫 1 次的效果，與呼叫 <em>N</em> 次的效果一樣，即可稱為是 idempotent：</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">var</span> <span class="nx">num</span> <span class="kt">int</span>

<span class="c1">// 查詢庫存量
</span><span class="c1"></span><span class="nx">num</span> <span class="p">=</span> <span class="nx">inventory</span><span class="p">.</span><span class="nf">GetQuantity</span><span class="p">(</span><span class="nx">item</span><span class="p">)</span>
<span class="nx">num</span> <span class="p">=</span> <span class="nx">inventory</span><span class="p">.</span><span class="nf">GetQuantity</span><span class="p">(</span><span class="nx">item</span><span class="p">)</span>
<span class="nx">num</span> <span class="p">=</span> <span class="nx">inventory</span><span class="p">.</span><span class="nf">GetQuantity</span><span class="p">(</span><span class="nx">item</span><span class="p">)</span>
<span class="c1">//...
</span><span class="c1"></span>
<span class="err"></span><span class="c1">// 設定庫存量
</span><span class="c1"></span><span class="nx">num</span> <span class="p">=</span> <span class="mi">100</span>
<span class="nx">inventory</span><span class="p">.</span><span class="nf">SetQuantity</span><span class="p">(</span><span class="nx">item</span><span class="p">,</span> <span class="nx">num</span><span class="p">)</span>
<span class="nx">inventory</span><span class="p">.</span><span class="nf">SetQuantity</span><span class="p">(</span><span class="nx">item</span><span class="p">,</span> <span class="nx">num</span><span class="p">)</span>
<span class="nx">inventory</span><span class="p">.</span><span class="nf">SetQuantity</span><span class="p">(</span><span class="nx">item</span><span class="p">,</span> <span class="nx">num</span><span class="p">)</span>
</code></pre></div><p>反之，像以下這些動作，呼叫 1 次的效果，與呼叫 <em>N</em> 次的效果會<strong>不一樣</strong>，即可稱為是 non-idempotent：</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="cm">/*...*/</span>                              <span class="c1">// 起初庫存量為 100
</span><span class="c1"></span><span class="nx">inventory</span><span class="p">.</span><span class="nf">DecreaseQuantity</span><span class="p">(</span><span class="nx">item</span><span class="p">)</span>     <span class="c1">// 庫存量會變成 99
</span><span class="c1"></span><span class="nx">inventory</span><span class="p">.</span><span class="nf">DecreaseQuantity</span><span class="p">(</span><span class="nx">item</span><span class="p">)</span>     <span class="c1">// 庫存量會變成 98
</span><span class="c1"></span><span class="nx">inventory</span><span class="p">.</span><span class="nf">DecreaseQuantity</span><span class="p">(</span><span class="nx">item</span><span class="p">)</span>     <span class="c1">// 庫存量會變成 97
</span></code></pre></div><h2 id="non-idempotent-操作有必要存在嗎">Non-idempotent 操作有必要存在嗎？</h2>
<p>在 <a href="https://en.wikipedia.org/wiki/Functional_programming">functional programming</a> 思潮下，immutability 及 idempotency 似乎才是政治正確之舉。</p>
<p>Non-idempotent 的操作，真的有必要存在嗎？</p>
<p>譬如說，即使沒有 non-idempotent 的 <code>DecreaseQuantity</code>，我們仍可透過 idempotent 的 <code>SetQuantity</code> 來達到一樣的效果：</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="nx">num</span> <span class="p">=</span> <span class="nx">inventory</span><span class="p">.</span><span class="nf">GetQuantity</span><span class="p">(</span><span class="nx">item</span><span class="p">)</span>       <span class="c1">// 起初庫存量為 100
</span><span class="c1"></span>
<span class="nx">numTarget</span> <span class="o">:=</span> <span class="nx">num</span> <span class="o">-</span> <span class="mi">1</span>
<span class="nx">inventory</span><span class="p">.</span><span class="nf">SetQuantity</span><span class="p">(</span><span class="nx">item</span><span class="p">,</span> <span class="nx">numTarget</span><span class="p">)</span>  <span class="c1">// 庫存量會變成 99
</span><span class="c1"></span>
<span class="nx">numTarget</span><span class="o">--</span>
<span class="nx">inventory</span><span class="p">.</span><span class="nf">SetQuantity</span><span class="p">(</span><span class="nx">item</span><span class="p">,</span> <span class="nx">numTarget</span><span class="p">)</span>  <span class="c1">// 庫存量會變成 98
</span><span class="c1"></span>
<span class="nx">numTarget</span><span class="o">--</span>
<span class="nx">inventory</span><span class="p">.</span><span class="nf">SetQuantity</span><span class="p">(</span><span class="nx">item</span><span class="p">,</span> <span class="nx">numTarget</span><span class="p">)</span>  <span class="c1">// 庫存量會變成 97
</span></code></pre></div><p>如此一來，是否真的沒有必要再留下 non-idempotent 的 <code>DecreaseQuantity</code>？至少有兩件事需要思考：</p>
<ol>
<li>
<p>語意層面的改變。原本 <code>DecreaseQuantity</code> 的簽名，並沒有「庫存量」這一欄，也就是說，client 並不需要知道「目前庫存量」，即可進行「庫存量減一」。如果改寫成 <code>SetQuantity</code> 版本，簽名不同，多了「庫存量」欄位，換句話說，原本不必知道的「庫存量」內容，現在就必須透露出來了——這改變了原本「庫存量減一」的操作語意。</p>
</li>
<li>
<p>同步問題。同一時間，萬一有別人也在透過這個新方法改動「庫存量」，就會發生 race condition。</p>
</li>
</ol>
<p>因此，某些時候，non-idempotency 可能無法完全迴避。</p>
<h2 id="http-的-idempotency-規範">HTTP 的 idempotency 規範</h2>
<p>HTTP 對於 idempotency 有一些規範。像 HTTP/1.1 的規格書 <a href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec9.html#sec9.1.2">§9.1.2</a> 就指出：</p>
<blockquote>
<p>Methods can also have the property of &ldquo;idempotence&rdquo; in that (aside from error or expiration issues) the side-effects of <em>N</em> &gt; 0 identical requests is the same as for a single request. The methods <code>GET</code>, <code>HEAD</code>, <code>PUT</code> and <code>DELETE</code> share this property. Also, the methods <code>OPTIONS</code> and <code>TRACE</code> SHOULD NOT have side effects, and so are inherently idempotent.</p>
</blockquote>
<p><a href="https://tools.ietf.org/html/rfc5789">RFC 5789</a> 也提到：</p>
<blockquote>
<p><code>PATCH</code> is neither safe nor idempotent as defined by <a href="https://tools.ietf.org/html/rfc2616">RFC2616</a>, Section 9.1.</p>
</blockquote>
<p>所以，綜合來說，在 HTTP 的標準規範當中，只有 <code>POST</code> 及 <code>PATCH</code> 不是 idempotent。</p>
<p>對這些 HTTP 細節感興趣的，請參考 ihower 的〈<a href="https://ihower.tw/blog/archives/6483">HTTP Verbs：談 POST, PUT 和 PATCH 的應用</a>〉一文。</p>
<h2 id="web-api-的-idempotency-問題">Web API 的 idempotency 問題</h2>
<p>前面的 Go 程式碼講的是 in process 場景。環境單純，沒有太多失敗、重試的未知狀況，不會有太大的 idempotency 問題。如果換成 out of process 場景，環境不再單純，網路環境不可靠，另一頭的通訊對象也不見得是穩定的，失敗、重試的未知狀況勢必增加，idempotency 就變成不得不去正視的議題。</p>
<p>譬如說，如果把管理商品庫存服務實作成 RESTful API：</p>

<details>
  <summary style="background-color:#f5f5f5;border:1px solid #ccc;padding:5px;">
    Go &#43; Gin 實作的 RESTful API 例子
    
  </summary>
  <div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;github.com/gin-gonic/gin&#34;</span>
	<span class="s">&#34;strconv&#34;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="c1">//...
</span><span class="c1"></span>	<span class="nx">router</span> <span class="o">:=</span> <span class="nx">gin</span><span class="p">.</span><span class="nf">Default</span><span class="p">()</span>

	<span class="c1">// 查詢庫存量
</span><span class="c1"></span>	<span class="nx">router</span><span class="p">.</span><span class="nf">GET</span><span class="p">(</span><span class="s">&#34;/inventory/quantity/:item_id&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">gin</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">{</span>
		<span class="c1">//...
</span><span class="c1"></span>		<span class="nx">num</span> <span class="err">：</span><span class="p">=</span> <span class="nx">inventory</span><span class="p">.</span><span class="nf">GetQuantity</span><span class="p">(</span><span class="nx">item</span><span class="p">)</span>
		<span class="c1">//...
</span><span class="c1"></span>	<span class="p">})</span>

	<span class="c1">// 設定庫存量
</span><span class="c1"></span>	<span class="nx">router</span><span class="p">.</span><span class="nf">PUT</span><span class="p">(</span><span class="s">&#34;/inventory/quantity/:item_id&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">gin</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">{</span>
		<span class="c1">//...
</span><span class="c1"></span>		<span class="nx">num</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">strconv</span><span class="p">.</span><span class="nf">Atoi</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nf">PostForm</span><span class="p">(</span><span class="s">&#34;num&#34;</span><span class="p">))</span>
		<span class="nx">inventory</span><span class="p">.</span><span class="nf">SetQuantity</span><span class="p">(</span><span class="nx">item</span><span class="p">,</span> <span class="nx">num</span><span class="p">)</span>
		<span class="c1">//...
</span><span class="c1"></span>	<span class="p">})</span>

	<span class="c1">// 庫存量減一
</span><span class="c1"></span>	<span class="nx">router</span><span class="p">.</span><span class="nf">POST</span><span class="p">(</span><span class="s">&#34;/inventory/quantity/:item_id/dec&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">gin</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">{</span>
		<span class="c1">//...
</span><span class="c1"></span>		<span class="nx">inventory</span><span class="p">.</span><span class="nf">DecreaseQuantity</span><span class="p">(</span><span class="nx">item</span><span class="p">)</span>
		<span class="c1">///
</span><span class="c1"></span>	<span class="p">})</span>

	<span class="nx">router</span><span class="p">.</span><span class="nf">Run</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></div>
</details>

<p>對於原本就是 idempotent 的 <code>GetQuantity</code> 和 <code>SetQuantity</code> 操作來說，換成 RESTful 版本並沒什麼問題。像以下這個例子中，Client 在 🅐 步驟向 Server 呼叫 query quantity 操作時，只要該資料沒被別人改動到，這個 🅐 步驟不管重試多少次，得到的結果都會是一樣的。</p>

<link rel="stylesheet" href="/css/hugo-easy-gallery.css" />
<div class="box">
<figure  itemprop="associatedMedia"
  itemscope itemtype="http://schema.org/ImageObject" 
  style="max-width:30em" >
    <div class="img">
      <img itemprop="thumbnail" src="/img/2020/03/restapi-idempotent.png" alt="Idempotent API operations"/>
    </div>
    <a href="/img/2020/03/restapi-idempotent.png" itemprop="contentUrl"></a>
      <figcaption>
          <p>Idempotent API operations</p>
      </figcaption>
  </figure>
</div>

<p>但是，對於原本就是 non-idempotent 的 <code>DecreaseQuantity</code> 操作來說，一遇到失敗、重試的未知狀況就麻煩了。像以下這個例子中，Client 在 🅑 步驟向 Server 呼叫 decrease quantity 操作時，Server 及 DB 都完成了各自的任務，可惜當 Server 在回傳結果給 Client 時，因為網路不穩定而漏失訊息。</p>
<p>Client 不會知道 🅑 背後涉及的各個環節究竟完成了多少，只會以為 🅑 步驟沒有生效，便主動以 🅑’ 步驟重試一次。Server 並不知道這個 🅑’ 只是個美麗的誤會，只能忠實地再執行一次 <code>DecreaseQuantity</code> 操作。於是，<code>DecreaseQuantity</code> 這個 non-idempotent 操作，就被錯誤地重複使用，造成錯誤的結果。</p>


<div class="box">
<figure  itemprop="associatedMedia"
  itemscope itemtype="http://schema.org/ImageObject" 
  style="max-width:30em" >
    <div class="img">
      <img itemprop="thumbnail" src="/img/2020/03/restapi-nonidempotent.png" alt="Non-idempotent API operations"/>
    </div>
    <a href="/img/2020/03/restapi-nonidempotent.png" itemprop="contentUrl"></a>
      <figcaption>
          <p>Non-idempotent API operations</p>
      </figcaption>
  </figure>
</div>

<p>這也是為什麼我們在一些沒有仔細處理 idempotency 的交易網站上，會看到這類警語：</p>
<blockquote>
<p>交易進行中，請勿按下【重新載入此頁】按鈕，以避免重複扣款。</p>
</blockquote>
<p>也就是說，他們認為，倘若因為電腦或網路不穩定而頻頻手動重試，從而導致的任何不良後果，都是使用者不聽勸告的錯。</p>
<h2 id="向-tcp-取經">向 TCP 取經</h2>
<p>在不穩定的分散式系統中，對於 non-idempotent 的操作，該如何避免重試所引發的問題？</p>
<p>不妨師法 TCP 吧，畢竟它算是在不可靠的 IP 傳輸環境中進行可靠傳輸的老祖宗了。</p>
<p>每一個 TCP segment 的 <a href="https://en.wikipedia.org/wiki/Transmission_Control_Protocol#TCP_segment_structure">header</a> 都帶有一個<strong>序列號</strong> (<strong>seq</strong>)，透過它，TCP 通訊的雙方，得以在不可靠的環境中，處理連線建立、流量控制、連線關閉等議題。<sup id="fnref:2"><a href="#fn:2" class="footnote-ref" role="doc-noteref">2</a></sup> 就以 TCP 的 3-way handshake 機制為例，雙方藉由 seq 來溝通是否成功地傳送與接收訊息：</p>


<div class="box">
<figure  itemprop="associatedMedia"
  itemscope itemtype="http://schema.org/ImageObject" 
  style="max-width:30em" >
    <div class="img">
      <img itemprop="thumbnail" src="/img/2020/03/tcp-3way-handshake.png" alt="TCP 3-way handshake"/>
    </div>
    <a href="/img/2020/03/tcp-3way-handshake.png" itemprop="contentUrl"></a>
      <figcaption>
          <p>TCP 3-way handshake</p>
      </figcaption>
  </figure>
</div>

<p>我們來分析 🅒 🅓 🅔 這幾種訊息丟失的狀況。</p>
<p>如果 🅒 訊息在中途就丟失了：</p>
<ul>
<li>那麼，Server 自然不會送出 🅓。</li>
<li>既然 Client 遲遲沒收到 🅓，也就會繼續重試 🅒 (seq=<em>x</em>)。</li>
</ul>
<p>如果 🅒 訊息成功送給 Server 了，但 🅓 訊息卻在中途就丟失了：</p>
<ul>
<li>既然 Client 遲遲沒收到 🅓，就會繼續重試 🅒 (seq=<em>x</em>)。</li>
<li>Server 在收到 🅒 時，會根據 seq=<em>x</em> 得知這是重複的訊息。</li>
</ul>
<p>如果 🅔 訊息在中途就丟失了：</p>
<ul>
<li>既然 Server 遲遲沒收到 🅔，就會繼續重試 🅓 (seq=<em>y</em>)。</li>
<li>Client 在收到 🅓 時，會根據 seq=<em>y</em> 得知這是重複的訊息。</li>
</ul>
<p>根據以上分析，我們可從 TCP 偷學一個祕訣：只要在 request 附上一個<strong>識別碼</strong>，就能讓通訊雙方偵測出失敗重試的情況，以採取對應的措施。</p>
<p>這就是 TCP 在 layer 4 進行的可靠傳輸措施。</p>
<h2 id="識別碼由誰來產生">識別碼，由誰來產生？</h2>
<p>這一招，不僅在 layer 4 行之有年，在 layer 7 也一樣管用。</p>
<p>接下來的問題是：識別碼，由誰來產生？由 request 的接收方，還是發起方？</p>
<p>識別碼可以由 request 接收方：server 產生。像 <a href="https://www.amazon.com/dp/0596801688/138-6991958-6648417"><em>Restful Web Services Cookbook</em></a> §10.8 &amp; §10.9 就建議，針對 non-idempotent 的操作，server 可先產生 <a href="https://en.wikipedia.org/wiki/Cryptographic_nonce">nonce</a> 當作識別碼，將它當成參數添加到服務的 URI 上面，再請 client 透過這個加過料的 URI 來操作 server 的服務。</p>
<p>也有人把識別碼的生成責任交給 request 發起方：client 來做。像 Stripe 官方提供的 <a href="https://github.com/stripe/stripe-ruby/blob/1a20c2476d35d80e411e5a692727ed5438614d66/lib/stripe/stripe_client.rb#L747">StripeClient 程式庫</a>，針對 <code>POST</code> 及 <code>DELETE</code> 類型的操作，會先在 client 這邊產生 uuid v4 當作識別碼，將它添加到 HTTP header 中（此例為 <code>Idempotency-Key</code>），再傳給 server：</p>
<div class="highlight"><pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="c1"># It is only safe to retry network failures on post and delete</span>
<span class="c1"># requests if we add an Idempotency-Key header</span>
<span class="k">if</span> <span class="o">%</span><span class="n">i</span><span class="o">[</span><span class="n">post</span> <span class="n">delete</span><span class="o">].</span><span class="n">include?</span><span class="p">(</span><span class="nb">method</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="no">Stripe</span><span class="o">.</span><span class="n">max_network_retries</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="n">headers</span><span class="o">[</span><span class="s2">&#34;Idempotency-Key&#34;</span><span class="o">]</span> <span class="o">||=</span> <span class="no">SecureRandom</span><span class="o">.</span><span class="n">uuid</span>
<span class="k">end</span>
</code></pre></div><p>簡單的概念，近年來較新的服務，尤其是與金流或電子商務有關的，似乎也很流行這種 “idempotency key” 手法：</p>
<ul>
<li>Adyen: <a href="https://docs.adyen.com/development-resources/api-idempotency">API idempotency</a></li>
<li>Airbnb: <a href="https://medium.com/airbnb-engineering/avoiding-double-payments-in-a-distributed-payments-system-2981f6b070bb">Avoiding Double Payments in a Distributed Payments System</a></li>
<li>Square: <a href="https://developer.squareup.com/docs/working-with-apis/idempotency">Working with APIs: Idempotency</a></li>
<li>Stitch Fix: <a href="https://multithreaded.stitchfix.com/blog/2017/06/26/patterns-of-soa-idempotency-key/">Patterns of Service-oriented Architecture: Idempotency Key</a></li>
<li>Stripe：<a href="https://stripe.com/docs/api/idempotent_requests">API Reference: Idempotent Requests</a></li>
</ul>
<p>概念很簡單，卻有個來歷不明的酷炫名詞 “<a href="https://stripe.com/blog/idempotency">idempotency key</a>”。根據 Stripe 工程師 <a href="https://twitter.com/brandur">Brandur Leach</a> 在 &ldquo;<a href="https://brandur.org/idempotency-keys">Implementing Stripe-like Idempotency Keys in Postgres</a>&rdquo; 一文所說，這名詞是 Stripe 發明的：</p>
<blockquote>
<p>An <strong>idempotency key</strong> is a unique value that’s generated by a client and sent to an API along with a request. The server stores the key to use for bookkeeping the status of that request on its end. If a request should fail partway through, the client retries with the <em>same</em> idempotency key value, and the server uses it to look up the request’s state and continue from where it left off. <strong>The name “idempotency key” comes from Stripe’s API.</strong></p>
</blockquote>
<p>在沒有進一步翻案證據之前，暫時姑且接受「這是 Stripe 發明的」的說法吧。</p>
<h2 id="idempotency-key-的生成">Idempotency key 的生成</h2>
<p>理論上，任何機制，只要在合理範圍內具有唯一性，就能用來產生 idempotency key。</p>
<p>但實務上，在實作 idempotency key 時，可能還需要考慮幾個議題：</p>
<ul>
<li>
<p>由資料庫自動產生，還是由程式邏輯層產生？</p>
</li>
<li>
<p>純亂數，還是單調遞增？</p>
</li>
</ul>
<p>資料庫能夠自動替我們產生單調遞增序號。只要將 idempotency key 宣告成 MySQL 的 <a href="https://dev.mysql.com/doc/refman/8.0/en/example-auto-increment.html"><code>auto_increment</code></a> 或 PostgreSQL 的 <a href="https://www.postgresql.org/docs/current/datatype-numeric.html#DATATYPE-SERIAL"><code>serial</code></a> 之類的資料型態，再搭配像 MySQL 的 <a href="https://dev.mysql.com/doc/refman/8.0/en/information-functions.html#function_last-insert-id"><code>last_insert_id()</code></a> 或 PostgreSQL 的 <a href="https://www.postgresql.org/docs/current/sql-insert.html"><code>insert returning</code></a> 之類的查詢語法，即可一次搞定 idempotency key 生成與儲存。</p>
<p>乍看之下很方便，不過，如果資料庫有分庫分表，就需要再額外處理，才能確保序號的唯一性。另一個或許更嚴重的缺點是，從架構潔癖的角度來看，違反了 <a href="https://www.tenlong.com.tw/products/9789864342945">clean architecture</a> 的分層原則與相依原則：</p>
<blockquote>
<p>資料庫是個細節，我們將這些東西放在外頭，在那邊它們不會有什麼危害。</p>
<p>資料庫不是資料模型。資料庫是一塊軟體，是提供對於資料存取的工具。它是一個低層級的細節——是一種機制。一名好的架構師，不會允許底層機制污染系統的架構。</p>
</blockquote>
<p>同樣有架構潔癖的 DDD，也不喜歡過於仰賴資料庫機制，像 <a href="https://www.amazon.com/dp/0321834577/ref=cm_sw_r_tw_dp_U_x_gp2zEbQ9DT5BB"><em>Implementing Domain-Driven Design</em></a> 的 §5.2 就直接建議大家將序號產生機制放在 Repository 層。<sup id="fnref:3"><a href="#fn:3" class="footnote-ref" role="doc-noteref">3</a></sup></p>
<p>如果要改由程式邏輯層產生 idempotency key，可能會直接套用 <a href="https://en.wikipedia.org/wiki/Universally_unique_identifier">uuid</a>，甚至訴諸 <a href="https://developer.twitter.com/en/docs/basics/twitter-ids">Snowflake</a>、<a href="https://github.com/sony/sonyflake">Sonyflake</a>、<a href="https://tech.meituan.com/2017/04/21/mt-leaf.html">Leaf</a> 這類分散式 ID 服務。不依賴資料庫，彈性大，也符合架構潔癖。</p>
<p>不依賴資料庫，符合了架構潔癖，是否會因此犧牲了資料庫的效能？接下來我們就來探討這議題。</p>
<h2 id="idempotency-key-的儲存">Idempotency key 的儲存</h2>
<p>透過程式邏輯產生的 id，可粗分為三大類：</p>
<ul>
<li>純亂數：像 <a href="https://www.uuidtools.com/uuid-versions-explained#version-4">uuid v4</a></li>
<li>局部單調遞增：像 <a href="https://www.uuidtools.com/uuid-versions-explained#version-1">uuid v1</a></li>
<li>全域單調遞增：像 <a href="https://developer.twitter.com/en/docs/basics/twitter-ids">Snowflake</a>、<a href="https://github.com/sony/sonyflake">Sonyflake</a>、<a href="https://tech.meituan.com/2017/04/21/mt-leaf.html">Leaf</a></li>
</ul>
<p>這些 idempotency key 該如何儲存，才可與資料庫內建的單調遞增序號一較高下？</p>
<p>理論上來說，在目前資料庫系統主流的 <a href="https://en.wikipedia.org/wiki/B%2B_tree">B+ tree</a> 索引結構下，單調遞增的數值，會比純亂數來得有效率。因此，若不計資料欄位大小差異，三者的存取效率，理論上應該會是 Snowflake &gt; uuid v1 &gt; uuid v4。</p>
<p>不過，我對於 PostgreSQL 提供的 <a href="https://www.postgresql.org/docs/current/datatype-uuid.html">uuid 資料型態</a>格外感興趣：</p>
<blockquote>
<p>PostgreSQL provides storage and comparison functions for UUIDs, but the core database does not include any function for generating UUIDs, because no single algorithm is well suited for every application.</p>
</blockquote>
<p>從 PostgreSQL 原始碼 <a href="https://github.com/postgres/postgres/blob/0a42a2e9ce8481a024d085f2cc526a366db8df59/src/include/utils/uuid.h#L17-L23">uuid.h</a> 及 <a href="https://github.com/postgres/postgres/blob/master/src/backend/utils/adt/uuid.c">uuid.c</a> 來看，骨子裡是用 16 bytes 字元陣列來實作：</p>
<div class="highlight"><pre class="chroma"><code class="language-c" data-lang="c"><span class="cm">/* uuid size in bytes */</span>
<span class="cp">#define UUID_LEN 16
</span><span class="cp"></span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">pg_uuid_t</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">data</span><span class="p">[</span><span class="n">UUID_LEN</span><span class="p">];</span>
<span class="p">}</span> <span class="n">pg_uuid_t</span><span class="p">;</span>


<span class="cm">/* internal uuid compare function */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">uuid_internal_cmp</span><span class="p">(</span><span class="k">const</span> <span class="n">pg_uuid_t</span> <span class="o">*</span><span class="n">arg1</span><span class="p">,</span> <span class="k">const</span> <span class="n">pg_uuid_t</span> <span class="o">*</span><span class="n">arg2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">memcmp</span><span class="p">(</span><span class="n">arg1</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">arg2</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">UUID_LEN</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* hash index support */</span>
<span class="n">Datum</span>
<span class="nf">uuid_hash</span><span class="p">(</span><span class="n">PG_FUNCTION_ARGS</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pg_uuid_t</span>  <span class="o">*</span><span class="n">key</span> <span class="o">=</span> <span class="n">PG_GETARG_UUID_P</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">hash_any</span><span class="p">(</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">UUID_LEN</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div><p>對於 uuid 的存取性能，PostgreSQL 似乎是有備而來胸有成竹。</p>
<p>因此，我針對 PostgreSQL 的 <code>uuid</code> 資料型態，分別實驗「亂數」與「遞增數值」存取效率，順便也拿 <code>bigint</code> 做對照組，看看這些排列組合，哪一種比較適合 idempotency key 用途：</p>
<table>
<thead>
<tr>
<th>Idempotency Key 類型</th>
<th>演算法</th>
<th>資料大小 (bytes)</th>
<th>PostgreSQL 資料型態</th>
</tr>
</thead>
<tbody>
<tr>
<td>亂數</td>
<td>uuid v4</td>
<td>16</td>
<td>uuid</td>
</tr>
<tr>
<td>遞增數值</td>
<td>uuid v1</td>
<td>16</td>
<td>uuid</td>
</tr>
<tr>
<td>遞增數值</td>
<td>Snowflake</td>
<td>8</td>
<td>bigint</td>
</tr>
</tbody>
</table>
<p>針對這些排列組合，我進行三組實驗：</p>
<ol>
<li>寫入 <em>N</em> 筆資料：InsertUuidV1、InsertUuidV4、InsertSnowflake</li>
<li>隨機存取 10% 資料，無 DB cache：SelectUuidV1/clean、InsertUuidV4/clean、InsertSnowflake/clean</li>
<li>隨機存取 10% 資料，有 DB cache：SelectUuidV1/cache、InsertUuidV4/cache、InsertSnowflake/cache</li>
</ol>
<p>實驗程式放在 <a href="https://github.com/William-Yeh/idempotency-key-test">https://github.com/William-Yeh/idempotency-key-test</a></p>
<p>我的實驗環境：</p>
<ul>
<li>MacBook Pro</li>
<li>CPU: 2.8 GHz 四核心Intel Core i7</li>
<li>Go: 1.14</li>
<li>PostgreSQL: 12.2</li>
</ul>
<p>首先牛刀小試一下，實驗 10 萬筆資料：</p>


<div class="box">
<figure  itemprop="associatedMedia"
  itemscope itemtype="http://schema.org/ImageObject" 
  style="max-width:30em" >
    <div class="img">
      <img itemprop="thumbnail" src="/img/2020/03/items-100k.png" alt="Test with N=100k"/>
    </div>
    <a href="/img/2020/03/items-100k.png" itemprop="contentUrl"></a>
      <figcaption>
          <p>Test with N=100k</p>
      </figcaption>
  </figure>
</div>

<p>乍看之下，三種 idempotency key 資料類型，彼此性能差異並不大。數量級分別是：</p>
<ol>
<li>寫入 <em>N</em> 筆資料：每秒能處理約 5*10³ 筆操作。</li>
<li>隨機存取 10% 資料，無 DB cache：每秒能處理約 5*10⁴ 筆操作。</li>
<li>隨機存取 10% 資料，有 DB cache：每秒能處理約 8*10⁴ 筆操作。</li>
</ol>
<p>放大十倍試試看，實驗 100 萬筆資料：</p>


<div class="box">
<figure  itemprop="associatedMedia"
  itemscope itemtype="http://schema.org/ImageObject" 
  style="max-width:30em" >
    <div class="img">
      <img itemprop="thumbnail" src="/img/2020/03/items-1m.png" alt="Test with N=1m"/>
    </div>
    <a href="/img/2020/03/items-1m.png" itemprop="contentUrl"></a>
      <figcaption>
          <p>Test with N=1m</p>
      </figcaption>
  </figure>
</div>

<p>最後，實驗 300 萬筆資料，順便看看三種 idempotency key 資料類型佔用的索引空間：</p>


<div class="box">
<figure  itemprop="associatedMedia"
  itemscope itemtype="http://schema.org/ImageObject" 
  style="max-width:30em" >
    <div class="img">
      <img itemprop="thumbnail" src="/img/2020/03/items-3m.png" alt="Test with N=3m"/>
    </div>
    <a href="/img/2020/03/items-3m.png" itemprop="contentUrl"></a>
      <figcaption>
          <p>Test with N=3m</p>
      </figcaption>
  </figure>
</div>

<p>執行速度差異不大。至於索引結構，則是 uuid v1 顯著偏高，而 uuid v4 與 snowflake 無太大差異。</p>
<p>綜合以上實驗，PostgreSQL 的 <code>uuid</code> 效能十分優異，足堪大任。我建議：如果你的 idempotency key 想要是亂數，可以直接把 uuid v4 存在 <code>uuid</code> 欄位中；如果你的 idempotency key 想要是單調遞增數值，不妨考慮把 snowflake 存在 <code>bigint</code> 欄位中。</p>
<p>如果你用的是其他資料庫系統，此處的建議不見得適用，請自行實驗。</p>
<h2 id="致謝">致謝</h2>
<p>實驗設計過程中，從 Carousell 同事得到許多建議，特此致謝。</p>
<p><a href="https://careers.carousell.com/">We&rsquo;re hiring!</a></p>
<section class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1" role="doc-endnote">
<p>嚴格來說，電腦領域講的 &ldquo;idempotency&rdquo;，已經與數學領域講的 &ldquo;idempotency&rdquo; 不盡相同了，可說是一種假借。詳情請見維基百科的說明： <a href="https://en.wikipedia.org/wiki/Idempotence#Computer_science_meaning">https://en.wikipedia.org/wiki/Idempotence#Computer_science_meaning</a> <a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:2" role="doc-endnote">
<p>對於 TCP 序列號機制感興趣的，可參考鄭中勝寫的三篇介紹文章：〈<a href="https://notfalse.net/26/tcp-seq">TCP 序列號 (Sequence Number, SEQ)</a>〉、〈<a href="https://notfalse.net/7/three-way-handshake">TCP 三向交握 (Three-way Handshake)</a>〉、〈<a href="https://notfalse.net/24/tcp-flow-control">TCP 流量控制 (Flow Control)</a>〉。 <a href="#fnref:2" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:3" role="doc-endnote">
<p>在 DDD 中，id 生成機制很適合放在 Repository 層。如果你沒有 <a href="https://www.amazon.com/dp/0321834577/ref=cm_sw_r_tw_dp_U_x_gp2zEbQ9DT5BB"><em>Implementing Domain-Driven Design</em></a> 這本書，也可以參考劉鳳軒寫的〈<a href="https://ithelp.ithome.com.tw/articles/10223150">DDD 戰術設計：Entity 概念與實作</a>〉一文。 <a href="#fnref:3" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</section>
    </div>

    
    
<div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">William Yeh</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
      2020-03-10
      
    </span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">授權條款</span>
    <span class="item-content"><a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh_TW" target="_blank">CC BY-NC-SA 4.0</a> (姓名標示-非商業性-相同方式分享 4.0 國際)</span>
  </p>
</div>


    
    

    <footer class="post-footer">
      <div class="post-tags">
          <a href="//william-yeh.net/tags/microservice/">microservice</a>
          <a href="//william-yeh.net/tags/ddd/">ddd</a>
          <a href="//william-yeh.net/tags/database/">database</a>
          
        </div>

      
      <nav class="post-nav">
        
          <a class="prev" href="/post/2020/03/grpc-load-balancing/">
            
            <i class="iconfont">
              <svg  class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M691.908486 949.511495l75.369571-89.491197c10.963703-12.998035 10.285251-32.864502-1.499144-44.378743L479.499795 515.267417 757.434875 204.940602c11.338233-12.190647 11.035334-32.285311-0.638543-44.850487l-80.46666-86.564541c-11.680017-12.583596-30.356378-12.893658-41.662889-0.716314L257.233596 494.235404c-11.332093 12.183484-11.041474 32.266891 0.657986 44.844348l80.46666 86.564541c1.772366 1.910513 3.706415 3.533476 5.750981 4.877077l306.620399 321.703933C662.505829 963.726242 680.945807 962.528973 691.908486 949.511495z"></path>
</svg>

            </i>
            <span class="prev-text nav-default">gRPC Load Balancing in Kubernetes</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        
          <a class="next" href="/post/2020/01/career-spotlight/">
            <span class="next-text nav-default">求職，別忘了突出你的亮點</span>
            <span class="prev-text nav-mobile">下一篇</span>
            
            <i class="iconfont">
              <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M332.091514 74.487481l-75.369571 89.491197c-10.963703 12.998035-10.285251 32.864502 1.499144 44.378743l286.278095 300.375162L266.565125 819.058374c-11.338233 12.190647-11.035334 32.285311 0.638543 44.850487l80.46666 86.564541c11.680017 12.583596 30.356378 12.893658 41.662889 0.716314l377.434212-421.426145c11.332093-12.183484 11.041474-32.266891-0.657986-44.844348l-80.46666-86.564541c-1.772366-1.910513-3.706415-3.533476-5.750981-4.877077L373.270379 71.774697C361.493148 60.273758 343.054193 61.470003 332.091514 74.487481z"></path>
</svg>

            </i>
          </a>
      </nav>
    </footer>
  </article>

  
  

  
  

  

  
  
    <div class="post bg-white">
      <script src="https://utteranc.es/client.js"
            repo= "William-Yeh/utterances-area"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
      </script>
    </div>
  

  

  

  <div class="disqus-comment">
  <div class="disqus-button" id="load_disqus" onclick="load_disqus()">
    顯示 Disqus 評論
  </div>
  <div id="disqus_thread"></div>
  <script type="text/javascript">
    var disqus_config = function () {
      this.page.url = "//william-yeh.net/post/2020/03/idempotency-key-test/";
    };
    function load_disqus() {
      
      
      if (window.location.hostname === 'localhost') return;

      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      var disqus_shortname = 'potioneer';
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);

      $('#load_disqus').remove();
    };
  </script>
  <noscript>Please enable JavaScript to view the
    <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a>
  </noscript>
  
  </div>

    

  

        </div>
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="icon-links">
  
  
    <a href="mailto:william.pjyeh@gmail.com" rel="me noopener" class="iconfont"
      title="email" >
      <svg class="icon" viewBox="0 0 1451 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M664.781909 681.472759 0 97.881301C0 3.997201 71.046997 0 71.046997 0L474.477909 0 961.649408 0 1361.641813 0C1361.641813 0 1432.688811 3.997201 1432.688811 97.881301L771.345323 681.472759C771.345323 681.472759 764.482731 685.154773 753.594283 688.65053L753.594283 688.664858C741.602731 693.493018 729.424896 695.068979 718.077952 694.839748 706.731093 695.068979 694.553173 693.493018 682.561621 688.664858L682.561621 688.65053C671.644501 685.140446 664.781909 681.472759 664.781909 681.472759L664.781909 681.472759ZM718.063616 811.603883C693.779541 811.016482 658.879232 802.205449 619.10784 767.734955 542.989056 701.759633 0 212.052267 0 212.052267L0 942.809523C0 942.809523 0 1024 83.726336 1024L682.532949 1024 753.579947 1024 1348.948139 1024C1432.688811 1024 1432.688811 942.809523 1432.688811 942.809523L1432.688811 212.052267C1432.688811 212.052267 893.138176 701.759633 817.019477 767.734955 777.248 802.205449 742.347691 811.03081 718.063616 811.603883L718.063616 811.603883Z"></path>
</svg>

    </a>
  
    <a href="https://twitter.com/william_yeh" rel="me noopener" class="iconfont"
      title="twitter"  target="_blank"
      >
      <svg class="icon" viewBox="0 0 1264 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M1229.8616 18.043658c0 0-117.852626 63.135335-164.151872 67.344358-105.225559-164.151872-505.082682-92.598492-437.738325 223.078185C278.622548 312.675223 89.216542 47.506814 89.216542 47.506814s-117.852626 189.406006 75.762402 345.139833C127.097743 396.85567 55.544363 371.601535 55.544363 371.601535S26.081207 535.753407 253.368414 615.724832c-21.045112 29.463156-113.643603 8.418045-113.643603 8.418045s25.254134 143.10676 231.496229 180.987961c-143.10676 130.479693-387.230056 92.598492-370.393967 105.225559 206.242095 189.406006 1119.599946 231.496229 1128.01799-643.98042C1179.353331 249.539887 1263.533778 123.269217 1263.533778 123.269217s-130.479693 37.881201-138.897738 33.672179C1225.652577 98.015083 1229.8616 18.043658 1229.8616 18.043658"></path>
</svg>

    </a>
  
    <a href="https://www.facebook.com/william.yeh" rel="me noopener" class="iconfont"
      title="facebook"  target="_blank"
      >
      <svg class="icon" style="" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="33" height="33">
  <path d="M965.7344 2.7648c14.848 0 28.2624 5.5296 40.2432 16.6912C1017.9584 30.5152 1024 43.52 1024 58.2656l0 910.2336c0 14.848-6.0416 27.7504-18.0224 38.8096C993.8944 1018.4704 980.48 1024 965.7344 1024L704.9216 1024 704.9216 629.9648l133.2224 0 19.456-155.4432-152.576 0L705.024 373.0432c0-50.688 25.9072-76.0832 77.7216-76.0832l80.4864 0L863.232 163.5328c-27.7504-5.4272-67.4816-8.192-119.296-8.192-59.1872 0-106.8032 18.0224-142.9504 54.0672C564.736 245.5552 546.7136 296.0384 546.7136 360.7552l0 113.7664L413.4912 474.5216l0 155.4432 133.2224 0L546.7136 1024 55.5008 1024c-14.848 0-27.7504-5.5296-38.8096-16.6912C5.5296 996.2496 0 983.3472 0 968.4992L0 58.2656C0 43.52 5.5296 30.5152 16.6912 19.456c11.0592-11.0592 24.064-16.6912 38.8096-16.6912L965.7344 2.7648z"></path>
</svg>

    </a>
  
    <a href="https://www.linkedin.com/in/pjyeh/" rel="me noopener" class="iconfont"
      title="linkedin"  target="_blank"
      >
      <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="33" height="33">
  <path d="M872.405333 872.618667h-151.637333v-237.610667c0-56.661333-1.152-129.578667-79.018667-129.578667-79.061333 0-91.136 61.653333-91.136 125.397334v241.792H398.976V384h145.664v66.602667h1.962667c20.352-38.4 69.845333-78.933333 143.786666-78.933334 153.642667 0 182.058667 101.12 182.058667 232.746667v268.202667zM227.712 317.141333a87.978667 87.978667 0 0 1-88.021333-88.106666 88.064 88.064 0 1 1 88.021333 88.106666z m76.032 555.477334H151.68V384h152.064v488.618667zM948.266667 0H75.562667C33.792 0 0 33.024 0 73.770667v876.458666C0 991.018667 33.792 1024 75.562667 1024h872.576C989.866667 1024 1024 991.018667 1024 950.229333V73.770667C1024 33.024 989.866667 0 948.138667 0h0.128z"></path>
</svg>

    </a>
  
    <a href="https://github.com/william-yeh" rel="me noopener" class="iconfont"
      title="github"  target="_blank"
      >
      <svg class="icon" style="" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M512 12.672c-282.88 0-512 229.248-512 512 0 226.261333 146.688 418.133333 350.08 485.76 25.6 4.821333 34.986667-11.008 34.986667-24.618667 0-12.16-0.426667-44.373333-0.64-87.04-142.421333 30.890667-172.458667-68.693333-172.458667-68.693333C188.672 770.986667 155.008 755.2 155.008 755.2c-46.378667-31.744 3.584-31.104 3.584-31.104 51.413333 3.584 78.421333 52.736 78.421333 52.736 45.653333 78.293333 119.850667 55.68 149.12 42.581333 4.608-33.109333 17.792-55.68 32.426667-68.48-113.706667-12.8-233.216-56.832-233.216-253.013333 0-55.893333 19.84-101.546667 52.693333-137.386667-5.76-12.928-23.04-64.981333 4.48-135.509333 0 0 42.88-13.738667 140.8 52.48 40.96-11.392 84.48-17.024 128-17.28 43.52 0.256 87.04 5.888 128 17.28 97.28-66.218667 140.16-52.48 140.16-52.48 27.52 70.528 10.24 122.581333 5.12 135.509333 32.64 35.84 52.48 81.493333 52.48 137.386667 0 196.693333-119.68 240-233.6 252.586667 17.92 15.36 34.56 46.762667 34.56 94.72 0 68.522667-0.64 123.562667-0.64 140.202666 0 13.44 8.96 29.44 35.2 24.32C877.44 942.592 1024 750.592 1024 524.672c0-282.752-229.248-512-512-512"></path>
</svg>

    </a>
  
    <a href="https://www.slideshare.net/williamyeh" rel="me noopener" class="iconfont"
      title="coding"  target="_blank"
      >
      <svg class="icon" style="" viewBox="0 0 1024 1024" version="1.1"
  width="36" height="36">
  <path
      d="m 313.5359,557.51414 c 9.229,0 16.57801,8.88719 16.57801,19.99616 0,11.10899 -7.34901,19.99617 -16.57801,19.99617 -9.229,0 -16.57801,-8.88718 -16.57801,-19.99617 0,-11.10897 7.34901,-19.99616 16.57801,-19.99616 z m 393.7706,0 c 9.22899,0 16.57802,8.88719 16.57802,19.99616 0,11.10899 -7.34903,19.99617 -16.57802,19.99617 -9.229,0 -16.57802,-8.88718 -16.57802,-19.99617 0,-11.10897 7.34902,-19.99616 16.57802,-19.99616 z"
      id="path6"/>
  <path
      d="m 945.8932,448.98796 c -27.17427,0 -51.1013,17.26164 -64.43208,43.23957 C 836.17066,393.44306 741.8298,302.00762 625.27096,264.23708 562.37704,239.1137 518.28294,190.57601 512.8139,134.17657 507.34486,190.74691 463.25077,239.1137 400.35685,264.23708 283.79802,301.83671 189.45714,393.44306 144.16669,492.22753 130.83591,466.2496 107.07979,448.98796 79.734607,448.98796 c -41.701401,0 -75.541066,40.84686 -75.541066,91.26454 0,50.41768 33.839665,91.26454 75.541066,91.26454 12.64715,0 24.610663,-3.75996 35.206923,-10.42536 3.58906,163.55837 180.30728,269.69186 397.87237,270.03367 217.5651,-0.34181 394.28332,-106.4753 397.87238,-270.03367 10.42535,6.6654 22.55977,10.42536 35.20692,10.42536 41.7014,0 75.541,-40.84686 75.541,-91.26454 0.171,-50.41768 -33.6687,-91.26454 -75.541,-91.26454 z M 114.2579,568.79403 c -3.58906,13.15987 -19.312535,18.79981 -35.206921,12.47625 -15.894385,-6.15267 -25.977916,-21.87616 -22.388867,-35.03602 3.58906,-13.15987 19.312533,-18.79981 35.206919,-12.47624 15.894389,6.15267 25.807019,21.87614 22.388869,35.03601 z m 398.556,276.69904 C 338.31748,845.15126 196.97707,762.603 196.97707,644.33509 c 0,-2.56361 0.1709,-4.95631 0.1709,-7.34902 0,-0.85453 0,-1.53817 0.17092,-2.3927 0.1709,-1.70908 0.34181,-3.41814 0.34181,-4.95631 0.1709,-2.22179 0.51273,-4.44359 0.85454,-6.6654 0,-0.1709 0,-0.51271 0.1709,-0.68362 3.58906,-23.2434 12.47624,-58.79214 26.14883,-79.13012 32.64331,-47.51224 90.92273,-78.9592 157.23479,-78.9592 51.1013,0 97.41721,18.79981 130.91506,49.05041 33.49784,-30.2506 79.64283,-49.05041 130.91504,-49.05041 66.48298,0 124.59148,31.61786 157.23479,78.9592 13.67259,20.50889 22.55977,55.88672 26.14883,79.13012 0,0.17091 0,0.51272 0.17091,0.68362 0.34182,2.22181 0.51272,4.44361 0.85453,6.6654 0.17091,1.70907 0.34181,3.24723 0.34181,4.95631 0,0.85453 0.17092,1.53817 0.17092,2.3927 0.17091,2.39271 0.17091,4.95631 0.17091,7.34902 C 828.82165,762.603 687.48124,845.15126 512.8139,845.49307 Z M 946.74774,581.27028 c -15.89439,6.15265 -31.61787,0.68362 -35.20692,-12.47625 -3.58906,-13.15987 6.49448,-28.88334 22.38887,-35.03601 15.89438,-6.15267 31.61786,-0.68363 35.20692,12.47624 3.41815,12.98896 -6.49448,28.71243 -22.38887,35.03602 z"
      id="path8"/>
</svg>

    </a>


<a href="//william-yeh.net/index.xml" rel="noopener alternate" type="application/rss&#43;xml"
    class="iconfont" title="rss" target="_blank">
    <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="30" height="30">
  <path d="M819.157333 1024C819.157333 574.592 449.408 204.8 0 204.8V0c561.706667 0 1024 462.293333 1024 1024h-204.842667zM140.416 743.04a140.8 140.8 0 0 1 140.501333 140.586667A140.928 140.928 0 0 1 140.074667 1024C62.72 1024 0 961.109333 0 883.626667s62.933333-140.544 140.416-140.586667zM678.784 1024h-199.04c0-263.210667-216.533333-479.786667-479.744-479.786667V345.173333c372.352 0 678.784 306.517333 678.784 678.826667z"></path>
</svg>

  </a>
   
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - <a class="theme-link" href="https://github.com/xianmin/hugo-theme-jane">Jane</a>
  </span>

  <span class="copyright-year">
    &copy;
    
      2015 -
    2020
    <span class="heart">
      
      <i class="iconfont">
        <svg class="icon" viewBox="0 0 1025 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="14" height="14">
  <path d="M1000.1 247.9c-15.5-37.3-37.6-70.6-65.7-98.9-54.4-54.8-125.8-85-201-85-85.7 0-166 39-221.4 107.4C456.6 103 376.3 64 290.6 64c-75.1 0-146.5 30.4-201.1 85.6-28.2 28.5-50.4 61.9-65.8 99.3-16 38.8-24 79.9-23.6 122.2 0.7 91.7 40.1 177.2 108.1 234.8 3.1 2.6 6 5.1 8.9 7.8 14.9 13.4 58 52.8 112.6 102.7 93.5 85.5 209.9 191.9 257.5 234.2 7 6.1 15.8 9.5 24.9 9.5 9.2 0 18.1-3.4 24.9-9.5 34.5-30.7 105.8-95.9 181.4-165 74.2-67.8 150.9-138 195.8-178.2 69.5-57.9 109.6-144.4 109.9-237.3 0.1-42.5-8-83.6-24-122.2z"
   fill="#8a8a8a"></path>
</svg>

      </i>
    </span><span class="author">
        William Yeh
        
      </span></span>

  
  
    <span id="busuanzi_container">
      访客数/访问量：<span id="busuanzi_value_site_uv"></span>/<span id="busuanzi_value_site_pv"></span>
    </span>
  

  
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont">
        
        <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="35" height="35">
  <path d="M510.866688 227.694839 95.449397 629.218702l235.761562 0-2.057869 328.796468 362.40389 0L691.55698 628.188232l241.942331-3.089361L510.866688 227.694839zM63.840492 63.962777l894.052392 0 0 131.813095L63.840492 195.775872 63.840492 63.962777 63.840492 63.962777zM63.840492 63.962777"></path>
</svg>

      </i>
    </div>
  </div>
  
<script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>




<script type="text/javascript" src="/js/main.638251f4230630f0335d8c6748e53a96f94b72670920b60c09a56fdc8bece214.js" integrity="sha256-Y4JR9CMGMPAzXYxnSOU6lvlLcmcJILYMCaVv3Ivs4hQ=" crossorigin="anonymous"></script>












  
    <script type="text/javascript" src="/js/load-photoswipe.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe.min.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe-ui-default.min.js"></script>
  




  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>












</body>
</html>
