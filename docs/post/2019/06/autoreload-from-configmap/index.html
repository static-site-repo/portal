<!DOCTYPE html>
<html lang="zh-tw" itemscope itemtype="http://schema.org/WebPage">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Auto-Reload from ConfigMap - Potioneer&#39;s Essays</title>
  

<meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta name="MobileOptimized" content="width"/>
<meta name="HandheldFriendly" content="true"/>


<meta name="applicable-device" content="pc,mobile">
<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<meta name="mobile-web-app-capable" content="yes">

<meta name="author" content="William Yeh" />
  <meta name="description" content="My previous article &amp;ldquo;Inotify in Containers&amp;rdquo; has demonstrated that when ConfigMap is mounted as directories, any changes in the ConfigMap will propagate to related pods, and can be detected with inotify-like APIs.
A follow-up question might be: what should a well-behaved application react to this trigger accordingly? What if it&amp;rsquo;s a ill-designed application?
To clarify this I&amp;rsquo;ve conducted a series of experiments. In this article I&amp;rsquo;m going to explain the experiments and preliminary findings." />




<meta name="google-site-verification" content="yB1imGx4TfWC72pIx33DNfg9RWg2gzU9CizwtvY5Hqo" />


<meta name="generator" content="Hugo 0.55.6" />


<link rel="canonical" href="//william-yeh.net/post/2019/06/autoreload-from-configmap/" />



<link rel="icon" href="/favicon.ico" />










<link href="/dist/jane.min.css?v=2.7.0" rel="stylesheet">




<meta property="og:title" content="Auto-Reload from ConfigMap" />
<meta property="og:description" content="My previous article &ldquo;Inotify in Containers&rdquo; has demonstrated that when ConfigMap is mounted as directories, any changes in the ConfigMap will propagate to related pods, and can be detected with inotify-like APIs.
A follow-up question might be: what should a well-behaved application react to this trigger accordingly? What if it&rsquo;s a ill-designed application?
To clarify this I&rsquo;ve conducted a series of experiments. In this article I&rsquo;m going to explain the experiments and preliminary findings." />
<meta property="og:type" content="article" />
<meta property="og:url" content="//william-yeh.net/post/2019/06/autoreload-from-configmap/" />
<meta property="article:published_time" content="2019-06-17T17:00:00&#43;08:00"/>
<meta property="article:modified_time" content="2019-06-17T17:00:00&#43;08:00"/>

<meta itemprop="name" content="Auto-Reload from ConfigMap">
<meta itemprop="description" content="My previous article &ldquo;Inotify in Containers&rdquo; has demonstrated that when ConfigMap is mounted as directories, any changes in the ConfigMap will propagate to related pods, and can be detected with inotify-like APIs.
A follow-up question might be: what should a well-behaved application react to this trigger accordingly? What if it&rsquo;s a ill-designed application?
To clarify this I&rsquo;ve conducted a series of experiments. In this article I&rsquo;m going to explain the experiments and preliminary findings.">


<meta itemprop="datePublished" content="2019-06-17T17:00:00&#43;08:00" />
<meta itemprop="dateModified" content="2019-06-17T17:00:00&#43;08:00" />
<meta itemprop="wordCount" content="497">



<meta itemprop="keywords" content="devops,docker,kubernetes,inotify,configmap," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Auto-Reload from ConfigMap"/>
<meta name="twitter:description" content="My previous article &ldquo;Inotify in Containers&rdquo; has demonstrated that when ConfigMap is mounted as directories, any changes in the ConfigMap will propagate to related pods, and can be detected with inotify-like APIs.
A follow-up question might be: what should a well-behaved application react to this trigger accordingly? What if it&rsquo;s a ill-designed application?
To clarify this I&rsquo;ve conducted a series of experiments. In this article I&rsquo;m going to explain the experiments and preliminary findings."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-751859-3', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>



</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Potioneer&#39;s Essays</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="//william-yeh.net/">♜</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="//william-yeh.net/post/">Archives</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="//william-yeh.net/tags/">Tags</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="//william-yeh.net/categories/">Categories</a>
          
        
      </li>
    
  </ul>
</nav>


  
    






  <link rel="stylesheet" href="/lib/photoswipe/photoswipe.min.css" />
  <link rel="stylesheet" href="/lib/photoswipe/default-skin/default-skin.min.css" />




<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>

  

  

  <header id="header" class="header container">
    <div class="logo-wrapper">
  <a href="/" class="logo">
    
      Potioneer&#39;s Essays
    
  </a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    
      <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="//william-yeh.net/">♜</a>
          

        

      </li>
    
      <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="//william-yeh.net/post/">Archives</a>
          

        

      </li>
    
      <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="//william-yeh.net/tags/">Tags</a>
          

        

      </li>
    
      <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="//william-yeh.net/categories/">Categories</a>
          

        

      </li>
    
    
  </ul>
</nav>

  </header>

  <div id="mobile-panel">
    <main id="main" class="main bg-llight">
      <div class="content-wrapper">
        <div id="content" class="content container">
          <article class="post bg-white">
    
    <header class="post-header">
      <h1 class="post-title">Auto-Reload from ConfigMap</h1>
      
      <div class="post-meta">
        <time datetime="2019-06-17" class="post-time">
          2019-06-17
        </time>
        <div class="post-category">
            <a href="//william-yeh.net/categories/tech/"> tech </a>
            
          </div>
        <span class="more-meta"> 約 497 字 </span>
          <span class="more-meta"> 預計閱讀 3 分鐘 </span>

        
        
          <span id="busuanzi_container_page_pv">
            | 阅读 <span id="busuanzi_value_page_pv"></span>
          </span>
        

        
        
      </div>
    </header>

    
    
<div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目錄</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#built-in-auto-reloading">Built-in auto-reloading</a></li>
<li><a href="#external-signals">External signals</a></li>
<li><a href="#pod-rollout">Pod rollout</a></li>
<li><a href="#conclusion">Conclusion</a></li>
</ul></li>
</ul>
</nav>
  </div>
</div>

    
    <div class="post-content">
      

<p>My previous article &ldquo;<a href="//william-yeh.net/post/2019/06/inotify-in-containers/">Inotify in Containers</a>&rdquo; has demonstrated that when ConfigMap is mounted as directories, any changes in the ConfigMap will propagate to related pods, and can be detected with <code>inotify</code>-like APIs.</p>

<p>A follow-up question might be: what should a well-behaved application react to this trigger accordingly? What if it&rsquo;s a ill-designed application?</p>

<p>To clarify this I&rsquo;ve conducted a series of experiments. In this article I&rsquo;m going to explain the experiments and preliminary findings.  All experiment materials can be found in the <a href="https://github.com/William-Yeh/configmap-auto-reload">configmap-auto-reload</a> repo.</p>

<h2 id="built-in-auto-reloading">Built-in auto-reloading</h2>

<p>Some applications (e.g., <a href="https://traefik.io/">Traefik</a>) are smart enough to gracefully reload themselves whenever they detect any configuration changes without downtime.  Will this work with Kubernetes ConfigMap?</p>

<p>See the <a href="https://github.com/William-Yeh/configmap-auto-reload/tree/master/traefik-example">traefik-example</a> demo:</p>

<p><a href="https://asciinema.org/a/251179"><img src="https://asciinema.org/a/251179.svg" alt="asciicast" /></a></p>

<p>Perfect!  Traefik auto-reloads itself as long as you correctly mount the <code>traefik-config</code> ConfigMap as <code>/etc/traefik/</code> directory for the pod.</p>

<h2 id="external-signals">External signals</h2>

<p>Some applications can <em>reload</em> configurations; but not <em>auto-reload</em>. Instead, they reload their configurations when they are <em>told</em> to do so.  For example, when Nginx receives a <code>HUP</code> signal (<code>nginx -s reload</code>) <sup class="footnote-ref" id="fnref:1"><a href="#fn:1">1</a></sup>, and when Apache HTTP Server receives a <code>HUP</code> signal (<code>apache -k restart</code>) or <code>USR1</code> signal (<code>apache -k graceful</code>) <sup class="footnote-ref" id="fnref:2"><a href="#fn:2">2</a></sup>, they will reload new configurations without downtime.</p>

<p>Who should be the <code>HUP</code> signal sender in Kubernetes?</p>

<p>Before Docker and Kubernetes rule the world, there were plenty of such tools, e.g., <a href="https://github.com/rvoicilas/inotify-tools">inotify-tools</a> and <a href="https://github.com/kimmobrunfeldt/chokidar-cli">Chokidar cli</a>.  People used them to watch for changes in specified directories and to invoke dedicated actions accordingly (including sending signals, of course).</p>

<p>Will this combo trick work with Kubernetes ConfigMap?</p>

<p>See the <a href="https://github.com/William-Yeh/configmap-auto-reload/tree/master/inotifywait-example">inotifywait-example</a> demo:</p>

<p><a href="https://asciinema.org/a/251666"><img src="https://asciinema.org/a/251666.svg" alt="asciicast" /></a></p>

<p>Good!  Inotifywait detects the changes and sends <code>HUP</code> signals to Nginx as long as you correctly mount the <code>nginx-config</code> ConfigMap as <code>/etc/nginx/</code> directory for the pod.</p>

<p>DISCLAIMER: it&rsquo;s just for demo; not a robust implementation. For more examples, see <sup class="footnote-ref" id="fnref:3"><a href="#fn:3">3</a></sup><sup class="footnote-ref" id="fnref:4"><a href="#fn:4">4</a></sup><sup class="footnote-ref" id="fnref:5"><a href="#fn:5">5</a></sup>.</p>

<h2 id="pod-rollout">Pod rollout</h2>

<p>Some applications do not have any configuration reloading mechanism. What should we do? Maybe the only reasonable way is to rollout their running instances, and just spawn new ones with the new configurations.</p>

<p><a href="https://github.com/stakater/Reloader">Reloader</a> is a generic solution for Kubernetes. With the help of it, pods can be restarted whenever related ConfigMap has changed.</p>

<p>See the <a href="https://github.com/William-Yeh/configmap-auto-reload/tree/master/reloader-example">reloader-example</a>:</p>

<p><a href="https://asciinema.org/a/251670"><img src="https://asciinema.org/a/251670.svg" alt="asciicast" /></a></p>

<p>Perfect!  Nginx pods get rolling updated by Reloader as long as you annotate the Nginx deployment with <code>configmap.reloader.stakater.com/reload</code> (see the <a href="https://github.com/William-Yeh/configmap-auto-reload/blob/master/reloader-example/nginx-service.yml#L25-L26">source code</a>):</p>

<div class="highlight"><pre class="chroma"><code class="language-plaintext" data-lang="plaintext">apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx
  annotations:
    configmap.reloader.stakater.com/reload: &#34;nginx-config&#34;
  ...</code></pre></div>

<h2 id="conclusion">Conclusion</h2>

<p>If your application is smart enough to gracefully reload itself whenever it detects any configuration changes, it continues working well with ConfigMap in Kubernetes.</p>

<p>If not so smart, an easier approach is to use automatic tools (e.g., <a href="https://github.com/stakater/Reloader">Reloader</a>) to rolling update related pods.</p>

<p>I will not recommend the watch+signal approach (e.g., <a href="https://github.com/rvoicilas/inotify-tools">inotify-tools</a>). It is prone to error and zombie processes.</p>

<div class="shortcode-notice note">
  <div class="shortcode-notice-title note">
    
      Series of Articles
    
  </div>
  

<p>❶ <a href="//william-yeh.net/post/2019/06/inotify-in-containers/">Inotify in Containers</a></p>

<p>❷ <a href="//william-yeh.net/post/2019/06/containers-and-env/">Containers and Environment Variables</a></p>

<p>➌ Auto-Reload from ConfigMap</p>

<p></div></p>
<div class="footnotes">

<hr />

<ol>
<li id="fn:1">Nginx official document: <a href="http://nginx.org/en/docs/control.html">Controlling nginx</a>
 <a class="footnote-return" href="#fnref:1"><sup>[return]</sup></a></li>
<li id="fn:2">Apache official document: <a href="https://httpd.apache.org/docs/2.4/stopping.html">Stopping and Restarting Apache HTTP Server</a>
 <a class="footnote-return" href="#fnref:2"><sup>[return]</sup></a></li>
<li id="fn:3">An implementation worth studying: <a href="https://github.com/rosskukulinski/nginx-kubernetes-reload">https://github.com/rosskukulinski/nginx-kubernetes-reload</a>
 <a class="footnote-return" href="#fnref:3"><sup>[return]</sup></a></li>
<li id="fn:4">Q&amp;A in Stack Overflow: <a href="https://stackoverflow.com/questions/41031170/nginx-reload-configuration-best-practice">Nginx Reload Configuration Best Practice</a>
 <a class="footnote-return" href="#fnref:4"><sup>[return]</sup></a></li>
<li id="fn:5"><a href="https://github.com/telephone/nginx-watch">https://github.com/telephone/nginx-watch</a>
 <a class="footnote-return" href="#fnref:5"><sup>[return]</sup></a></li>
</ol>
</div>

    </div>

    
    
<div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">William Yeh</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">2019-06-17</span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">授權條款</span>
    <span class="item-content"><a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh_TW" target="_blank">CC BY-NC-SA 4.0</a> (姓名標示-非商業性-相同方式分享 4.0 國際)</span>
  </p>
</div>

    
    

    <footer class="post-footer">
      <div class="post-tags">
          <a href="//william-yeh.net/tags/devops/">devops</a>
          <a href="//william-yeh.net/tags/docker/">docker</a>
          <a href="//william-yeh.net/tags/kubernetes/">kubernetes</a>
          <a href="//william-yeh.net/tags/inotify/">inotify</a>
          <a href="//william-yeh.net/tags/configmap/">configmap</a>
          
        </div>

      
      <nav class="post-nav">
        
        
          <a class="next" href="/post/2019/06/containers-and-env/">
            <span class="next-text nav-default">Containers and Environment Variables</span>
            <span class="prev-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>

  
  

  
  
    <div class="post bg-white">
      <script src="https://utteranc.es/client.js"
            repo= "William-Yeh/utterances-area"
            issue-term="pathname"
            crossorigin="anonymous"
            async>
      </script>
    </div>
  

  

  

  <div class="disqus-comment">
  <div class="disqus-button" id="load_disqus" onclick="load_disqus()">
    顯示 Disqus 評論
  </div>
  <div id="disqus_thread"></div>
  <script type="text/javascript">
    var disqus_config = function () {
      this.page.url = "//william-yeh.net/post/2019/06/autoreload-from-configmap/";
    };
    function load_disqus() {
      
      
      if (window.location.hostname === 'localhost') return;

      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      var disqus_shortname = 'potioneer';
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);

      $('#load_disqus').remove();
    };
  </script>
  <noscript>Please enable JavaScript to view the
    <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a>
  </noscript>
  
  </div>

        </div>
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="mailto:william.pjyeh@gmail.com" rel="me noopener" class="iconfont icon-email"
        title="email">
      </a>
      <a href="https://twitter.com/william_yeh" rel="me noopener" class="iconfont icon-twitter"
        title="twitter" target="_blank">
      </a>
      <a href="https://www.facebook.com/william.yeh" rel="me noopener" class="iconfont icon-facebook"
        title="facebook" target="_blank">
      </a>
      <a href="https://www.linkedin.com/in/pjyeh/" rel="me noopener" class="iconfont icon-linkedin"
        title="linkedin" target="_blank">
      </a>
      <a href="https://github.com/william-yeh" rel="me noopener" class="iconfont icon-github"
        title="github" target="_blank">
      </a>
      <a href="https://www.slideshare.net/williamyeh" rel="me noopener" class="iconfont icon-coding"
        title="coding" target="_blank">
      </a>
  <a href="//william-yeh.net/index.xml" rel="noopener alternate" type="application/rss&#43;xml" class="iconfont icon-rss"
    title="rss" target="_blank">
  </a>
  </div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - <a class="theme-link" href="https://github.com/xianmin/hugo-theme-jane">Jane</a>
  </span>

  <span class="copyright-year">
    &copy;
    
      2015 -
    2019
    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span><span class="author">
        William Yeh
        
      </span></span>

  
  
    <span id="busuanzi_container">
      访客数/访问量：<span id="busuanzi_value_site_uv"></span>/<span id="busuanzi_value_site_pv"></span>
    </span>
  
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
<script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
<script type="text/javascript" src="/dist/jane.min.js?v=2.7.0"></script>





  
    <script type="text/javascript" src="/js/load-photoswipe.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe.min.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe-ui-default.min.js"></script>
  




  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>








</body>
</html>
